name: Build and Release

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgtk-3-dev \
          libsecret-1-dev \
          libgcrypt20-dev \
          libssl-dev \
          libcurl4-openssl-dev \
          libxml2-dev \
          libjsoncpp-dev \
          libsqlite3-dev \
          libfirebird3-dev \
          libpq-dev \
          libmysqlclient-dev \
          libwxgtk3.2-dev \
          wx3.2-headers \
          wx3.2-i18n
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -G Ninja \
          -DWITH_SYSTEM_WXWIDGETS=ON
    
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} -j$(nproc)
    
    - name: Test
      working-directory: build
      run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure || true
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: scratchrobin-linux
        path: build/ScratchRobin

  build-appimage:
    runs-on: ubuntu-22.04
    needs: build-linux
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgtk-3-dev \
          libsecret-1-dev \
          libwxgtk3.2-dev
    
    - name: Build AppImage
      run: |
        cd ScratchRobin
        ./build-appimage.sh
    
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: scratchrobin-appimage
        path: ScratchRobin/ScratchRobin-*.AppImage

  build-windows:
    runs-on: windows-2022
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Install dependencies
      run: |
        choco install -y cmake ninja
    
    - name: Configure CMake
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -G "Visual Studio 17 2022" `
          -A x64
    
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: scratchrobin-windows
        path: build/${{ env.BUILD_TYPE }}/ScratchRobin.exe

  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-appimage, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/scratchrobin-linux/ScratchRobin
          artifacts/scratchrobin-appimage/*.AppImage
          artifacts/scratchrobin-windows/ScratchRobin.exe
        draft: true
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') }}
        generate_release_notes: true
