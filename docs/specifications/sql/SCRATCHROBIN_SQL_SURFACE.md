# ScratchRobin SQL Surface Contract

**Status**: Draft  
**Last Updated**: 2026-02-05

---

## Purpose

Defines the SQL surface ScratchRobin emits and accepts for UI-managed objects. ScratchRobin uses **ScratchBirdSQL** as the authoritative dialect, with an explicit subset for generation and validation.

---

## Authoritative Dialect

- ScratchBirdSQL grammar is defined in ScratchBird:
  - `ScratchBird/docs/specifications/parser/SCRATCHBIRD_SQL_COMPLETE_BNF.md`
  - `ScratchBird/docs/specifications/parser/ScratchBird SQL Language Specification - Master Document.md`

ScratchRobin must generate SQL that conforms to this grammar.

---

## Scope

### Emitted SQL

ScratchRobin emits SQL for:
- Tables, columns, constraints
- Views
- Indexes
- Triggers
- Procedures/functions
- Schema creation
 - Sequences
 - Domains (custom types)

### Accepted SQL

ScratchRobin accepts:
- DDL and DML in the SQL editor
- DDL generated by the design model
- For non-ScratchBird backends: accepted SQL is limited by backend capability flags, but is still translated or validated against ScratchBirdSQL when possible

---

## Object-Specific SQL Rules

### Tables

- `CREATE TABLE` with explicit column list and constraints.
- Use `PRIMARY KEY` inline when a single-column primary key, otherwise table-level constraint.
- All column types must map to ScratchBirdSQL types.

### Indexes

- `CREATE INDEX` with explicit schema and table name.
- Named indexes required for Git sync and rollback.

### Views

- `CREATE VIEW schema.view AS SELECT ...`
- ScratchRobin does not emit `CREATE OR REPLACE` in v1 to keep migration semantics clear.

### Procedures/Functions

- SQL bodies must conform to ScratchBirdSQL procedural rules (SBL where applicable).
- For UI-generated procedures, use `LANGUAGE SQL` unless specified.

--- 
## Per-Manager SQL Specs

For detailed SQL surface by manager:
- `docs/specifications/sql/managers/TABLES_SQL_SURFACE.md`
- `docs/specifications/sql/managers/VIEWS_SQL_SURFACE.md`
- `docs/specifications/sql/managers/INDEXES_SQL_SURFACE.md`
- `docs/specifications/sql/managers/TRIGGERS_SQL_SURFACE.md`
- `docs/specifications/sql/managers/PROCEDURES_FUNCTIONS_SQL_SURFACE.md`
- `docs/specifications/sql/managers/SEQUENCES_SQL_SURFACE.md`
- `docs/specifications/sql/managers/SCHEMAS_SQL_SURFACE.md`
- `docs/specifications/sql/managers/DOMAINS_SQL_SURFACE.md`

---

## Validation Rules

- All generated SQL must parse under ScratchBirdSQL grammar.
- All identifiers must be escaped according to ScratchBirdSQL rules.
- SQL emitted for migrations must not contain dialect-specific extensions unless explicitly tagged with a backend requirement.

---

## Examples

### Example: Create Table

```sql
CREATE TABLE public.users (
  id INT64 PRIMARY KEY,
  email VARCHAR(255) NOT NULL,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### Example: Create Index

```sql
CREATE INDEX idx_users_email ON public.users (email);
```

### Example: Create View

```sql
CREATE VIEW public.active_users AS
SELECT id, email
FROM public.users
WHERE active = true;
```

---

## Edge Cases

- **Mixed case identifiers**: must be quoted to preserve case.
- **Reserved keywords**: must be quoted or renamed.
- **Unsupported types**: must be mapped to closest ScratchBirdSQL type, with warning if precision loss occurs.

---

## Implementation Notes

- Statement generation should flow through a shared SQL builder to ensure consistency.
- Validation uses ScratchBirdSQL parser in strict mode.
