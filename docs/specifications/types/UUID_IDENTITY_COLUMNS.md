# UUID Identity Columns Specification

## Overview

ScratchBird extends the traditional IDENTITY column concept to support UUID generation, particularly UUID v7 which provides time-ordered, sortable UUIDs ideal for distributed systems and primary keys.

## UUID Identity Syntax

### Column Definition

```sql
-- Basic UUID IDENTITY
CREATE TABLE users (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7),
    username VARCHAR(100)
);

-- UUID with specific version
CREATE TABLE events (
    event_id UUID GENERATED BY DEFAULT AS IDENTITY (UUID VERSION 7),
    event_time TIMESTAMP
);

-- UUID v4 (random)
CREATE TABLE tokens (
    token_id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 4),
    token_value TEXT
);

-- Custom UUID generator
CREATE TABLE custom_entities (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID CUSTOM 'my_uuid_gen'),
    data JSONB
);
```

### Supported UUID Versions

```sql
-- UUID Version Support
UUID VERSION 1  -- MAC address based (deprecated, security concerns)
UUID VERSION 3  -- MD5 namespace based
UUID VERSION 4  -- Random
UUID VERSION 5  -- SHA-1 namespace based
UUID VERSION 6  -- Reordered UUID v1 for database keys
UUID VERSION 7  -- Time-ordered (RECOMMENDED for primary keys)
UUID VERSION 8  -- Custom/vendor specific

-- Default is VERSION 7 for optimal database performance
CREATE TABLE products (
    id UUID GENERATED ALWAYS AS IDENTITY,  -- Uses UUID v7 by default
    name VARCHAR(200)
);
```

## UUID v7 Specification

### Structure (128 bits)

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                           unix_ts_ms                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          unix_ts_ms           |  ver  |       rand_a          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|var|                        rand_b                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                            rand_b                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Where:
- unix_ts_ms: 48-bit big-endian unsigned Unix timestamp (milliseconds)
- ver: 4-bit version field (0111 for v7)
- rand_a: 12 bits of randomness
- var: 2-bit variant field (10 for RFC4122)
- rand_b: 62 bits of randomness
```

### Benefits of UUID v7 for IDENTITY

```sql
-- Time-ordered for better index performance
-- Monotonically increasing (within same millisecond, random but still sortable)
-- No index fragmentation issues like UUID v4
-- Globally unique without coordination
-- Contains timestamp information

-- Example: UUID v7 values are naturally ordered
SELECT id, created_at FROM events ORDER BY id;
-- Returns chronologically ordered results without using created_at
```

## Advanced Identity Options

### Generation Strategies

```sql
-- ALWAYS: Cannot override, cannot insert explicit value
CREATE TABLE strict_ids (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7),
    data TEXT
);
-- INSERT INTO strict_ids (id, data) VALUES ('manual-uuid', 'test'); -- ERROR

-- BY DEFAULT: Can override with explicit value
CREATE TABLE flexible_ids (
    id UUID GENERATED BY DEFAULT AS IDENTITY (UUID VERSION 7),
    data TEXT
);
-- INSERT INTO flexible_ids (id, data) VALUES ('manual-uuid', 'test'); -- OK

-- ON NULL: Generate only if NULL provided
CREATE TABLE nullable_ids (
    id UUID GENERATED BY DEFAULT ON NULL AS IDENTITY (UUID VERSION 7),
    data TEXT
);
```

### Sequence-Like Options for UUIDs

```sql
-- Node ID for distributed systems (ensures uniqueness across nodes)
CREATE TABLE distributed_entities (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 7
        NODE ID 42  -- 0-1023 for UUID v7
    ),
    data JSONB
);

-- Counter component for high-frequency inserts
CREATE TABLE high_frequency_events (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 7
        SEQUENCE COMPONENT  -- Uses internal counter for rand_a field
    ),
    event_data TEXT
);

-- Clock sequence for UUID v1/v6
CREATE TABLE legacy_compatible (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 6
        CLOCK SEQUENCE 16383  -- 14-bit value
    ),
    data TEXT
);
```

### Namespace-Based UUIDs (v3 and v5)

```sql
-- UUID v5 with namespace
CREATE TABLE namespaced_items (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 5
        NAMESPACE 'dns'  -- or 'url', 'oid', 'x500', or custom UUID
        NAME COLUMN 'item_name'  -- Use another column as input
    ),
    item_name VARCHAR(100) UNIQUE NOT NULL,
    data JSONB
);

-- Custom namespace UUID
CREATE TABLE tenant_objects (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 5
        NAMESPACE '6ba7b810-9dad-11d1-80b4-00c04fd430c8'  -- Custom namespace
        NAME EXPRESSION (tenant_id || '::' || object_name)
    ),
    tenant_id INT,
    object_name VARCHAR(100),
    data JSONB
);
```

## Custom UUID Generators

### Defining Custom Generators

```sql
-- Create custom UUID generator function
CREATE FUNCTION my_custom_uuid_gen() RETURNS UUID AS $$
DECLARE
    result UUID;
BEGIN
    -- Custom logic here
    -- Example: UUID v7 with custom node embedding
    result := generate_uuid_v7_with_node(get_server_node_id());
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- Register as identity generator
CREATE UUID GENERATOR my_uuid_gen AS FUNCTION my_custom_uuid_gen;

-- Use in table
CREATE TABLE custom_table (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID CUSTOM 'my_uuid_gen'),
    data TEXT
);
```

### Pluggable UUID Libraries

```sql
-- Register external UUID library
CREATE UUID GENERATOR ulid_gen AS EXTERNAL 
    LIBRARY 'ulid_extension'
    FUNCTION 'generate_ulid';

-- Use ULID (Universally Unique Lexicographically Sortable Identifier)
CREATE TABLE ulid_table (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID CUSTOM 'ulid_gen'),
    data JSONB
);
```

## Identity Column Management

### Altering Identity Columns

```sql
-- Add identity to existing column
ALTER TABLE existing_table 
    ALTER COLUMN id 
    ADD GENERATED ALWAYS AS IDENTITY (UUID VERSION 7);

-- Change UUID version
ALTER TABLE users 
    ALTER COLUMN id 
    SET GENERATED ALWAYS AS IDENTITY (UUID VERSION 7);

-- Remove identity
ALTER TABLE users 
    ALTER COLUMN id 
    DROP IDENTITY;

-- Change generation strategy
ALTER TABLE users 
    ALTER COLUMN id 
    SET GENERATED BY DEFAULT;
```

### Identity Column Information

```sql
-- System view for UUID identity columns
CREATE VIEW sys.uuid_identity_columns AS
SELECT 
    t.table_schema,
    t.table_name,
    c.column_name,
    ic.generation_type,    -- ALWAYS, BY DEFAULT, ON NULL
    ic.uuid_version,       -- 1-8
    ic.uuid_options,       -- JSONB with additional options
    ic.custom_generator,   -- Name if custom
    ic.namespace_uuid,     -- For v3/v5
    ic.name_source        -- Column or expression for v3/v5
FROM 
    information_schema.tables t
    JOIN information_schema.columns c USING (table_schema, table_name)
    JOIN sys.identity_columns ic USING (column_id)
WHERE 
    c.data_type = 'uuid' 
    AND ic.is_identity = true;
```

## Performance Considerations

### Index Optimization for UUID v7

```sql
-- UUID v7 is designed for B-tree indexes
CREATE TABLE optimized_table (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7) PRIMARY KEY,
    data JSONB
);
-- Primary key index will have minimal fragmentation

-- Covering index with UUID v7
CREATE INDEX idx_events_id_time 
    ON events(id) 
    INCLUDE (event_time)
    WHERE id IS NOT NULL;
```

### Partitioning with UUID Identity

```sql
-- Time-based partitioning using UUID v7 timestamp component
CREATE TABLE events (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7),
    event_data JSONB
) PARTITION BY RANGE (uuid_timestamp(id));

-- Create partitions
CREATE TABLE events_2024_01 PARTITION OF events
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE events_2024_02 PARTITION OF events
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

## Functions for UUID Manipulation

### Extraction Functions

```sql
-- Extract timestamp from UUID v7
CREATE FUNCTION uuid_timestamp(uuid_val UUID) RETURNS TIMESTAMP AS $$
BEGIN
    -- Extract first 48 bits as milliseconds since epoch
    RETURN to_timestamp(
        ('x' || substr(uuid_val::text, 1, 8) || 
         substr(uuid_val::text, 10, 4))::bit(48)::bigint / 1000.0
    );
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Extract version
CREATE FUNCTION uuid_version(uuid_val UUID) RETURNS INT AS $$
BEGIN
    RETURN ('x' || substr(uuid_val::text, 15, 1))::bit(4)::int;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Extract node ID from UUID v7 (if embedded)
CREATE FUNCTION uuid_node_id(uuid_val UUID) RETURNS INT AS $$
BEGIN
    -- Extract from rand_a field if using node embedding
    RETURN ('x' || substr(uuid_val::text, 16, 3))::bit(12)::int & 1023;
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

### Generation Functions

```sql
-- Manual UUID v7 generation
CREATE FUNCTION generate_uuid_v7() RETURNS UUID AS $$
DECLARE
    unix_ts_ms BIGINT;
    rand_a BIGINT;
    rand_b BIGINT;
    result TEXT;
BEGIN
    unix_ts_ms := extract(epoch from now()) * 1000;
    rand_a := floor(random() * 4096);  -- 12 bits
    rand_b := floor(random() * power(2, 62));  -- 62 bits
    
    -- Construct UUID v7
    result := lpad(to_hex(unix_ts_ms), 12, '0') ||
              '7' || -- version
              lpad(to_hex(rand_a), 3, '0') ||
              '8' || -- variant (10xx)
              lpad(to_hex(rand_b), 15, '0');
    
    -- Format as UUID
    RETURN result::UUID;
END;
$$ LANGUAGE plpgsql;

-- UUID v7 with guaranteed monotonicity
CREATE FUNCTION generate_uuid_v7_monotonic() RETURNS UUID AS $$
DECLARE
    last_uuid UUID;
    new_uuid UUID;
BEGIN
    -- Get last generated UUID
    SELECT last_value INTO last_uuid FROM sys.uuid_v7_sequence;
    
    LOOP
        new_uuid := generate_uuid_v7();
        EXIT WHEN new_uuid > last_uuid OR last_uuid IS NULL;
        -- If same millisecond, increment random part
        PERFORM pg_sleep(0.001);
    END LOOP;
    
    -- Update sequence
    UPDATE sys.uuid_v7_sequence SET last_value = new_uuid;
    RETURN new_uuid;
END;
$$ LANGUAGE plpgsql;
```

## Migration and Compatibility

### Converting Existing Tables

```sql
-- Convert SERIAL/BIGSERIAL to UUID identity
ALTER TABLE old_table ADD COLUMN new_id UUID;

UPDATE old_table 
SET new_id = generate_uuid_v7();

ALTER TABLE old_table 
    ALTER COLUMN new_id 
    SET NOT NULL,
    ALTER COLUMN new_id 
    ADD GENERATED BY DEFAULT AS IDENTITY (UUID VERSION 7);

-- Migrate foreign keys
ALTER TABLE related_table 
    ADD COLUMN new_fk UUID;

UPDATE related_table r
SET new_fk = o.new_id
FROM old_table o
WHERE r.old_fk = o.id;

-- Switch primary key
ALTER TABLE old_table 
    DROP CONSTRAINT old_table_pkey,
    ADD PRIMARY KEY (new_id);
```

### Compatibility with Other Databases

```sql
-- PostgreSQL compatible
CREATE TABLE pg_compatible (
    id UUID DEFAULT gen_random_uuid(),  -- Maps to UUID v4
    data TEXT
);

-- MySQL compatible
CREATE TABLE mysql_compatible (
    id BINARY(16) DEFAULT (UUID_TO_BIN(UUID())),  -- Maps to UUID
    data TEXT
);

-- SQL Server compatible  
CREATE TABLE mssql_compatible (
    id UNIQUEIDENTIFIER DEFAULT NEWID(),  -- Maps to UUID v4
    data NVARCHAR(MAX)
);

-- ScratchBird enhanced
CREATE TABLE scratchbird_enhanced (
    id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7),
    data TEXT
);
```

## System Configuration

### UUID Generation Settings

```sql
-- System-wide defaults
ALTER SYSTEM SET default_uuid_version = 7;
ALTER SYSTEM SET uuid_node_id = 42;  -- For distributed systems
ALTER SYSTEM SET uuid_monotonic_generation = true;

-- Per-session settings
SET LOCAL default_uuid_version = 7;
SET LOCAL uuid_generation_buffer_size = 100;  -- Pre-generate UUIDs
```

### Performance Tuning

```sql
-- UUID generation cache
ALTER SYSTEM SET uuid_cache_size = 1000;  -- Pre-generate and cache

-- Monotonic sequence buffer
ALTER SYSTEM SET uuid_v7_sequence_buffer = 10;  -- Prevent conflicts
```

## Examples

### E-commerce Application

```sql
-- Orders with UUID v7 for time-ordering
CREATE TABLE orders (
    order_id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7) PRIMARY KEY,
    customer_id UUID NOT NULL,
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total DECIMAL(10,2)
);

-- Order items with composite key
CREATE TABLE order_items (
    order_id UUID REFERENCES orders(order_id),
    item_id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7),
    product_id UUID NOT NULL,
    quantity INT,
    PRIMARY KEY (order_id, item_id)
);
```

### Multi-tenant SaaS

```sql
-- Tenant-specific UUID generation
CREATE TABLE tenants (
    tenant_id UUID GENERATED ALWAYS AS IDENTITY (UUID VERSION 7) PRIMARY KEY,
    tenant_name VARCHAR(100)
);

-- Tenant data with namespace-based UUIDs
CREATE TABLE tenant_data (
    id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 5
        NAMESPACE COLUMN 'tenant_id'
        NAME EXPRESSION (object_type || '::' || object_name)
    ) PRIMARY KEY,
    tenant_id UUID REFERENCES tenants(tenant_id),
    object_type VARCHAR(50),
    object_name VARCHAR(100),
    data JSONB
);
```

### Event Sourcing

```sql
-- Event store with guaranteed ordering
CREATE TABLE event_store (
    event_id UUID GENERATED ALWAYS AS IDENTITY (
        UUID VERSION 7
        SEQUENCE COMPONENT  -- Ensures ordering within millisecond
    ) PRIMARY KEY,
    aggregate_id UUID NOT NULL,
    event_type VARCHAR(100),
    event_data JSONB,
    event_timestamp TIMESTAMP GENERATED ALWAYS AS (uuid_timestamp(event_id)) STORED,
    INDEX idx_aggregate_events (aggregate_id, event_id)
);
```

This comprehensive UUID IDENTITY specification provides ScratchBird with modern, distributed-system-friendly primary key generation!