# SBSEC-04.03 Nonce and IV Specification for AES-GCM

**WAL Scope:** ScratchBird does not use write-after log (WAL) for recovery in Alpha; any WAL support is optional post-gold (replication/PITR).
Any WAL IV rules in this document apply only to an optional post-gold WAL stream
for replication/PITR.

## 1. Purpose

Provides **normative** nonce/IV generation rules and test vectors for all AES-GCM uses in ScratchBird.
This document is referenced by SBSEC-04 ยง6.4.

## 2. Definitions

- `IV`: 96-bit nonce required by AES-GCM.
- `key_version`: version identifier for the AEAD key in use.
- `page_id_64`: stable 64-bit identifier for a page within a database.
- `page_enc_epoch`: 32-bit monotonic counter per `(page_id_64, key_version)`.

All fields are big-endian.

## 3. Page Encryption IV (TDE)

### 3.1 Construction (96 bits)

`IV = page_id_64 || key_version_16 || page_enc_epoch_32`

### 3.2 Requirements

- `page_enc_epoch` MUST increment **before** each encrypted page write under the same `key_version`.
- `page_enc_epoch` MUST be stored durably in the page header and MUST NOT roll back after crash.
- Key rotation resets the epoch scope because `key_version` changes.

### 3.3 Worked Example

Inputs:
- `page_id_64 = 0x1122334455667788`
- `key_version_16 = 0x0007`
- `page_enc_epoch_32 = 0x0000002A`

IV bytes (hex):
`11 22 33 44 55 66 77 88 00 07 00 00 00 2A`

## 4. Write-after log (WAL, optional post-gold) / Log IV

### 4.1 Construction

`IV = wal_incarnation_32 || lsn_64`

### 4.2 Requirements

- `wal_incarnation_32` MUST increment whenever the write-after log (WAL, optional post-gold) stream is reset/rebased or when the write-after log (WAL, optional post-gold) key_version changes.
- `lsn_64` MUST be unique within a write-after log (WAL, optional post-gold) incarnation.

## 5. IPC AEAD IV

### 5.1 Construction

`IV = channel_nonce_prefix_32 || seq_64`

Where `channel_nonce_prefix_32` is derived from HKDF with channel context, and `seq_64` is strictly monotonic per direction.

### 5.2 Requirements

- Sequence numbers MUST be persisted in memory for the life of the channel and reset only on rekey.
- Replays MUST be rejected (SBSEC-05.A).
