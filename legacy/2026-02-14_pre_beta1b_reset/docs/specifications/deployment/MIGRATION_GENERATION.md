# Migration Generation Specification

**Status**: Draft  
**Last Updated**: 2026-02-05

---

## Purpose

Defines how ScratchRobin generates migration scripts from design changes using ScratchBirdSQL.

---

## Inputs

- Baseline schema snapshot (extracted or last deployed)
- Current design model
- Object change list

---

## Output

Migration scripts stored in the database Git repository:

- Forward migration: `V####__description.sql`
- Rollback migration (optional): `R####__description.sql`

---

## Generation Rules

1. Order changes by dependency:
   - Schemas
   - Tables
   - Constraints
   - Indexes
   - Views
   - Procedures/Functions
2. Use stable names and deterministic ordering.
3. For destructive changes, require explicit confirmation.

---

## Step Schema

Each migration script must include:
- Header block
- Forward SQL
- Optional rollback SQL

**Header Example**

```sql
-- Migration: V0002__add_orders
-- Generated by ScratchRobin
-- Created: 2026-02-05T12:00:00Z
-- Author: alice
```

---

## Failure Modes

- **Invalid SQL**: generation fails before commit.
- **Conflicting migration ID**: generation fails unless user overrides.
- **Unsafe destructive change**: warning + confirmation required.

---

## Edge Cases

- Rename is represented as DROP + CREATE in v1.
- Type narrowing emits warning.
- View dependencies are regenerated after table changes.

