# SBSEC-05.A IPC Wire Format and Examples


## 1. Purpose

Defines the **normative** message framing, authenticated data (AAD), nonce construction, replay rules, and examples
for ScratchBird IPC (engine <-> parser).

This appendix complements SBSEC-05.

## 2. Message Framing

All IPC messages MUST be framed as:

```
struct IpcFrameV1 {
  u32  magic;          // 'SBIP' = 0x53424950
  u16  version;        // 0x0001
  u16  msg_type;       // REGISTER, REGISTER_ACK, SBLR, RESULT, ERROR, HEARTBEAT, ROTATE, ...
  u64  channel_id;     // unique per channel
  u64  seq;            // monotonic per direction
  u32  flags;          // bits: ENCRYPTED, COMPRESSED, FRAGMENTED, ...
  u32  aad_len;        // length of AAD bytes that follow (optional; usually 0, engine-defined)
  u32  body_len;       // length of body (ciphertext if ENCRYPTED)
  u8   aad[aad_len];
  u8   body[body_len];
}
```

## 3. AEAD Protection

When `ENCRYPTED`:
- body is `AES-256-GCM(ciphertext || tag)`.
- AAD MUST include the fixed header fields: (magic, version, msg_type, channel_id, seq, flags) serialized big-endian.

## 4. Nonce/IV

`IV = channel_nonce_prefix_32 || seq_64` (see SBSEC-04.03).

`channel_nonce_prefix_32` MUST be derived from HKDF with channel context:
- inputs include engine ephemeral pubkey, parser ephemeral pubkey, and the channel binding token.

## 5. Replay Rules

- Receiver maintains `expected_seq` per channel direction.
- Frames with `seq < expected_seq` MUST be rejected.
- Frames with `seq > expected_seq` MAY be rejected or buffered; the default is reject (simpler and safer).

## 6. Key Rotation

Rotation MUST:
- establish new channel keys via HKDF,
- reset sequence numbers to 0 for the new key epoch,
- increment a `key_epoch` counter (implicit via HKDF context or explicit in flags/header).

## 7. Examples (Illustrative)

### 7.1 REGISTER

1) Parser -> Engine: REGISTER (unencrypted) with spawn token, parser UUID, dialect namespace, capabilities.
2) Engine -> Parser: REGISTER_ACK with channel_id, channel binding token, and whether encryption is required.
3) If encryption required, run ECDH/HKDF exchange and switch to encrypted frames.

### 7.2 Encrypted SBLR Message

- msg_type = SBLR
- seq increments
- AAD = fixed header fields
- IV = prefix||seq
- body = AES-GCM(ciphertext||tag)

