# SBSEC-04.01 Key Lifecycle and State Machines

**WAL Scope:** ScratchBird does not use write-after log (WAL) for recovery in Alpha; any WAL support is optional post-gold (replication/PITR).
Any WAL key material in this document applies only to an optional post-gold WAL
stream for replication/PITR.

## 1. Purpose

This document defines the **normative** lifecycle, state machines, and failure handling for ScratchBird cryptographic keys.
It complements SBSEC-04 (Encryption & Key Management) and is intended to prevent “works in happy path” implementations that
fail under crash, rollback, or partial rotation.

## 2. Key Objects and Scope

This spec applies to the following key types (see SBSEC-04 for the hierarchy):
- CMK: Cluster Master Key
- DBK: Database Root Key
- DEK: Data Encryption Key (page/TDE)
- TSK: Tablespace Key (if used)
- Write-after log (WAL, optional post-gold)/KLK: Write-after log (WAL, optional post-gold)/Log Key (if used)
- SDK/CSK: credential / secret store keys (if implemented)
- MEK: Memory Encryption Key (Level 6 only)

## 3. Common Key States (Normative)

Every persisted key record MUST include a `state` with one of:

- `ACTIVE`: used for new encryption operations.
- `ROTATING`: rotation in progress; key may still be required for reads/decrypt.
- `RETIRED`: no longer used for new encryption; retained for decrypt until policy allows destruction.
- `DESTROYED`: key material irrecoverably removed; decrypt operations MUST fail.

### 3.1 State Transition Rules

Allowed transitions:

- `ACTIVE -> ROTATING -> RETIRED -> DESTROYED`
- `ACTIVE -> RETIRED` (explicit early retirement)
- `ROTATING -> ACTIVE` (rollback only if rotation not committed; see §4)

Disallowed transitions (MUST NOT occur):
- `RETIRED -> ACTIVE`
- `DESTROYED -> *` (no resurrection)

## 4. Rotation Protocol (Crash-Safe)

Rotation MUST be implemented as a two-phase protocol.

### 4.1 Phase 1: Prepare

1. Generate `new_key` material.
2. Persist new key record as `ROTATING` with:
   - `key_version = old_version + 1`
   - `created_at`, `created_by`
   - wrapped/encrypted key material
3. Emit audit event `KEY_ROTATION_PREPARED`.

### 4.2 Phase 2: Activate (Commit Point)

1. Update the key selector for the target scope to point to `new_version` as `ACTIVE`.
2. Mark previous `ACTIVE` key as `RETIRED`.
3. Persist the change atomically with any required catalog epochs.
4. Emit audit event `KEY_ROTATION_ACTIVATED`.

**Crash rule:** After restart, the engine MUST be able to determine whether activation occurred by reading durable key state.
If a key is `ROTATING` but not selected as active, the engine MUST treat it as “prepared but not activated” and may:
- retry activation, or
- delete the ROTATING key record (if allowed), emitting audit.

## 5. Retirement and Destruction

### 5.1 Retirement

When a key becomes `RETIRED`, it MUST remain available for decrypt until:
- all encrypted data/pages/log records using that key have been re-encrypted under a newer key, OR
- policy defines retention (e.g., keep 90 days), OR
- the database is decommissioned.

### 5.2 Destruction

Destruction MUST:
- zeroize in-memory material,
- remove wrapped key material from persistent stores,
- emit audit event `KEY_DESTROYED` with key id/version and justification.

**Irreversibility:** Once `DESTROYED`, the engine MUST NOT attempt recovery or fallback.

## 6. Required Audit Events

Implementations MUST emit at least:
- `KEY_ROTATION_PREPARED`
- `KEY_ROTATION_ACTIVATED`
- `KEY_RETIRED`
- `KEY_DESTROYED`
- `KEY_IMPORT` / `KEY_EXPORT` (if supported)

## 7. Security Level Requirements

- Levels 0–2: rotation MAY be manual; audit optional.
- Levels 3–4: rotation SHOULD be supported; audit required per SBSEC-09.
- Level 5: rotation MUST be supported for DEK/write-after log (WAL, optional post-gold) keys; crash-safe protocol required.
- Level 6: quorum rules MAY be required for CMK/MEK changes; see SBSEC-06.01/06.02.
