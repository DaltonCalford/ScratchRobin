# SBSEC-04.02 Key Material Handling Requirements


## 1. Purpose

Defines **normative** requirements for handling key material in memory, on disk, and across IPC.

## 2. In-Memory Handling

Implementations MUST:
- allocate key material in dedicated buffers,
- zeroize buffers on free and on rotation/destruction,
- avoid copying key bytes into logs, exceptions, or crash dumps.

Recommended (higher levels):
- `mlock`/page-lock where available for long-lived master keys,
- constant-time comparisons for key identifiers and MACs,
- structured “key handles” instead of raw bytes in most APIs.

## 3. On-Disk Handling

Persisted key material MUST be stored only in **wrapped** form (encrypted by a parent key or HSM/KMS).
Plaintext key material MUST NOT be written to disk.

Key records MUST include:
- `key_id` (UUIDv7),
- `key_version`,
- `algorithm`,
- `state` (SBSEC-04.01),
- `wrapped_by` (parent key id/version or KMS reference),
- `created_at`, `created_by`,
- optional `retire_at`, `destroy_at`.

## 4. IPC / Transport Handling

When key material (or derived session keys) crosses IPC boundaries:
- it MUST be protected by authenticated encryption at levels requiring IPC encryption (SBSEC-05),
- it MUST be scoped to a channel/session and short-lived,
- it MUST be rotated/rekeyed on demand and on parser restart.

## 5. Logging and Redaction

Key material MUST NEVER appear in logs. Keys may be referenced by:
- key id (UUID),
- version,
- algorithm,
- state.

Any diagnostic output MUST redact secrets by default.

## 6. HSM/KMS Integration

If an external KMS/HSM is used:
- the engine MUST treat it as the source of CMK authority,
- wrapping/unwrapping operations MUST be audited,
- outage behavior MUST be defined (fail closed at higher levels).

